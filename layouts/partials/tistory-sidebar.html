{{/* Tistory-style sidebar with categories, recent posts, and recent comments */}}

<div class="tistory-sidebar">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
    
    {{/* Categories */}}
    <div class="tistory-sidebar-section">
      <h3 class="tistory-sidebar-title">{{ i18n "categories.label" | default "카테고리" }}</h3>
      <div class="tistory-category-list">
        <ul>
          {{ range .Site.Taxonomies.categories }}
            <li>
              <a href="{{ .Page.RelPermalink }}">
                {{ .Page.Title }}
                <span class="tistory-category-count">({{ .Count }})</span>
              </a>
            </li>
          {{ end }}
        </ul>
      </div>
    </div>
    
    {{/* Recent Posts */}}
    <div class="tistory-sidebar-section">
      <h3 class="tistory-sidebar-title">{{ i18n "article.recent" | default "새로운 이야기" }}</h3>
      <ul class="tistory-sidebar-list">
        {{ range first 12 .Site.RegularPages }}
          <li>
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          </li>
        {{ end }}
      </ul>
    </div>
    
    {{/* Recent Comments - Disqus integration */}}
    <div class="tistory-sidebar-section">
      <h3 class="tistory-sidebar-title">{{ i18n "article.comments" | default "새로운 댓글" }}</h3>
      <ul id="recent-comments-list" class="tistory-sidebar-list">
        <li class="text-neutral-500 dark:text-neutral-400 text-sm loading-comments">
          {{ i18n "global.loading_comments" | default "댓글을 불러오는 중..." }}
        </li>
      </ul>
    </div>
    
  </div>
</div>

{{/* Disqus Recent Comments Script */}}
<script>
(function() {
  const DISQUS_SHORTNAME = 'hellojinwoo';
  const CURRENT_LANG = '{{ .Site.Language.Lang | default "ko" }}';
  const MAX_COMMENTS = 12;
  const PREVIEW_LENGTH = 40;
  const SITE_URL = '{{ .Site.BaseURL }}';
  
  function truncateText(text, maxLength) {
    if (!text) return '';
    text = text.replace(/<[^>]*>/g, '').trim(); // Remove HTML tags
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
  }
  
  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) return CURRENT_LANG === 'ko' ? '오늘' : CURRENT_LANG === 'fr' ? "Aujourd'hui" : 'Today';
    if (days === 1) return CURRENT_LANG === 'ko' ? '어제' : CURRENT_LANG === 'fr' ? 'Hier' : 'Yesterday';
    if (days < 7) return CURRENT_LANG === 'ko' ? days + '일 전' : CURRENT_LANG === 'fr' ? 'Il y a ' + days + ' jours' : days + ' days ago';
    
    return date.toLocaleDateString(CURRENT_LANG === 'ko' ? 'ko-KR' : 
                                   CURRENT_LANG === 'fr' ? 'fr-FR' : 'en-US', {
      month: 'short',
      day: 'numeric'
    });
  }
  
  function normalizeUrl(url) {
    // Convert localhost URLs to production URLs for proper linking
    if (!url) return '#';
    return url.replace(/http:\/\/localhost:\d+/g, SITE_URL.replace(/\/$/, ''));
  }
  
  function isCommentForCurrentLang(threadLink) {
    // Parse the thread URL to check language
    if (!threadLink) return false;
    
    try {
      const url = new URL(threadLink.replace(/http:\/\/localhost:\d+/g, 'https://hellojinwoo.github.io'));
      const pathname = url.pathname;
      
      // Korean (default): URLs like /posts/... (no /en/ or /fr/ prefix)
      // English: URLs like /en/posts/...
      // French: URLs like /fr/posts/...
      
      if (CURRENT_LANG === 'ko') {
        // Korean: must NOT start with /en/ or /fr/
        return !pathname.startsWith('/en/') && !pathname.startsWith('/fr/');
      } else if (CURRENT_LANG === 'en') {
        // English: must start with /en/
        return pathname.startsWith('/en/');
      } else if (CURRENT_LANG === 'fr') {
        // French: must start with /fr/
        return pathname.startsWith('/fr/');
      }
      return true;
    } catch (e) {
      return true; // If URL parsing fails, include the comment
    }
  }
  
  function renderComments(comments) {
    const container = document.getElementById('recent-comments-list');
    if (!container) return;
    
    // Filter by language, spam, deleted status, then take first MAX_COMMENTS
    const validComments = comments.filter(function(comment) {
      if (comment.isSpam || comment.isDeleted || !comment.thread || !comment.thread.link) {
        return false;
      }
      return isCommentForCurrentLang(comment.thread.link);
    }).slice(0, MAX_COMMENTS);
    
    if (validComments.length === 0) {
      container.innerHTML = '<li class="text-neutral-500 dark:text-neutral-400 text-sm">' +
        (CURRENT_LANG === 'ko' ? '아직 댓글이 없습니다.' :
         CURRENT_LANG === 'fr' ? 'Pas encore de commentaires.' :
         'No comments yet.') + '</li>';
      return;
    }
    
    container.innerHTML = validComments.map(function(comment) {
      const author = comment.author ? comment.author.name : 'Anonymous';
      const preview = truncateText(comment.raw_message || comment.message, PREVIEW_LENGTH);
      const date = formatDate(comment.createdAt);
      const link = normalizeUrl(comment.thread.link);
      
      return '<li class="recent-comment-item">' +
        '<a href="' + link + '#disqus_thread" class="recent-comment-link">' +
          '<span class="recent-comment-text">' + preview + '</span>' +
          '<span class="recent-comment-meta">' +
            '<span class="recent-comment-author">' + author + '</span>' +
            '<span class="recent-comment-date">' + date + '</span>' +
          '</span>' +
        '</a>' +
      '</li>';
    }).join('');
  }
  
  function fetchRecentComments() {
    // Disqus API endpoint for recent comments
    const apiUrl = 'https://disqus.com/api/3.0/forums/listPosts.json' +
      '?forum=' + DISQUS_SHORTNAME +
      '&limit=50' +
      '&related=thread' +
      '&order=desc' +
      '&api_key=E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F';
    
    fetch(apiUrl)
      .then(function(response) {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(function(data) {
        if (data.code === 0 && data.response) {
          renderComments(data.response);
        } else {
          throw new Error('Disqus API error');
        }
      })
      .catch(function(error) {
        console.error('Error fetching comments:', error);
        const container = document.getElementById('recent-comments-list');
        if (container) {
          container.innerHTML = '<li class="text-neutral-500 dark:text-neutral-400 text-sm">' +
            (CURRENT_LANG === 'ko' ? '댓글을 불러올 수 없습니다.' :
             CURRENT_LANG === 'fr' ? 'Impossible de charger les commentaires.' :
             'Unable to load comments.') + '</li>';
        }
      });
  }
  
  // Fetch comments when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchRecentComments);
  } else {
    fetchRecentComments();
  }
})();
</script>
