{{/* Tistory-style sidebar with categories, recent posts, and recent comments */}}

<div class="tistory-sidebar">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
    
    {{/* Categories */}}
    <div class="tistory-sidebar-section">
      <h3 class="tistory-sidebar-title">{{ i18n "sidebar.categories" | default "카테고리" }}</h3>
      <div class="tistory-category-list">
        <ul>
          {{ range .Site.Taxonomies.categories }}
            <li>
              <a href="{{ .Page.RelPermalink }}">
                {{ .Page.Title }}
                <span class="tistory-category-count">({{ .Count }})</span>
              </a>
            </li>
          {{ end }}
        </ul>
      </div>
    </div>
    
    {{/* Recent Posts */}}
    <div class="tistory-sidebar-section">
      <h3 class="tistory-sidebar-title">{{ i18n "sidebar.recent_posts" | default "새로운 이야기" }}</h3>
      <ul class="tistory-sidebar-list">
        {{ range first 12 .Site.RegularPages }}
          <li>
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          </li>
        {{ end }}
      </ul>
    </div>
    
    {{/* Recent Comments - Disqus API integration */}}
    <div class="tistory-sidebar-section">
      <h3 class="tistory-sidebar-title">{{ i18n "sidebar.recent_comments" | default "새로운 댓글" }}</h3>
      <ul id="recent-comments-list" class="tistory-sidebar-list">
        <li class="text-neutral-500 dark:text-neutral-400 text-sm loading-comments">
          {{ i18n "sidebar.loading_comments" | default "댓글을 불러오는 중..." }}
        </li>
      </ul>
    </div>
    
  </div>
</div>

{{/* Disqus Recent Comments Script - URL-based filtering with JSONP */}}
<script>
(function() {
  const DISQUS_SHORTNAME = 'hellojinwoo';
  const API_KEY = 'zfHDothhhqbsLeyJiEwdzFE7GJ8nem8NqYcAWgerP5cx5PRpk9OfcuqkUO56jNLz';
  const CURRENT_LANG = '{{ .Site.Language.Lang | default "ko" }}';
  const MAX_COMMENTS = 12;
  const PREVIEW_LENGTH = 40;
  const SITE_URL = 'https://hellojinwoo.github.io';
  
  // Global callback for JSONP
  window.disqusRecentCommentsCallback = function(data) {
    if (data.code === 0 && data.response) {
      renderComments(data.response);
    } else {
      showError();
    }
  };
  
  function truncateText(text, maxLength) {
    if (!text) return '';
    text = text.replace(/<[^>]*>/g, '').trim();
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
  }
  
  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) return CURRENT_LANG === 'ko' ? '오늘' : CURRENT_LANG === 'fr' ? "Aujourd'hui" : 'Today';
    if (days === 1) return CURRENT_LANG === 'ko' ? '어제' : CURRENT_LANG === 'fr' ? 'Hier' : 'Yesterday';
    if (days < 7) return CURRENT_LANG === 'ko' ? days + '일 전' : CURRENT_LANG === 'fr' ? 'Il y a ' + days + ' jours' : days + ' days ago';
    
    return date.toLocaleDateString(CURRENT_LANG === 'ko' ? 'ko-KR' : 
                                   CURRENT_LANG === 'fr' ? 'fr-FR' : 'en-US', {
      month: 'short',
      day: 'numeric'
    });
  }
  
  function normalizeUrl(url) {
    if (!url) return '#';
    return url.replace(/http:\/\/localhost:\d+/g, SITE_URL);
  }
  
  function isCommentForCurrentSection(threadLink) {
    if (!threadLink) return false;
    
    try {
      const normalizedLink = normalizeUrl(threadLink);
      const url = new URL(normalizedLink);
      const pathname = url.pathname;
      
      if (CURRENT_LANG === 'ko') {
        return !pathname.startsWith('/en/') && !pathname.startsWith('/fr/');
      } else if (CURRENT_LANG === 'en') {
        return pathname.startsWith('/en/');
      } else if (CURRENT_LANG === 'fr') {
        return pathname.startsWith('/fr/');
      }
      return true;
    } catch (e) {
      return true;
    }
  }
  
  function showError() {
    const container = document.getElementById('recent-comments-list');
    if (container) {
      container.innerHTML = '<li class="text-neutral-500 dark:text-neutral-400 text-sm">' +
        (CURRENT_LANG === 'ko' ? '댓글을 불러올 수 없습니다.' :
         CURRENT_LANG === 'fr' ? 'Impossible de charger les commentaires.' :
         'Unable to load comments.') + '</li>';
    }
  }
  
  function renderComments(comments) {
    const container = document.getElementById('recent-comments-list');
    if (!container) return;
    
    const validComments = comments.filter(function(comment) {
      if (comment.isSpam || comment.isDeleted || !comment.thread || !comment.thread.link) {
        return false;
      }
      return isCommentForCurrentSection(comment.thread.link);
    }).slice(0, MAX_COMMENTS);
    
    if (validComments.length === 0) {
      container.innerHTML = '<li class="text-neutral-500 dark:text-neutral-400 text-sm">' +
        (CURRENT_LANG === 'ko' ? '아직 댓글이 없습니다.' :
         CURRENT_LANG === 'fr' ? 'Pas encore de commentaires.' :
         'No comments yet.') + '</li>';
      return;
    }
    
    container.innerHTML = validComments.map(function(comment) {
      const author = comment.author ? comment.author.name : 'Anonymous';
      const preview = truncateText(comment.raw_message || comment.message, PREVIEW_LENGTH);
      const date = formatDate(comment.createdAt);
      const link = normalizeUrl(comment.thread.link);
      
      return '<li class="recent-comment-item">' +
        '<a href="' + link + '#disqus_thread" class="recent-comment-link">' +
          '<span class="recent-comment-text">' + preview + '</span>' +
          '<span class="recent-comment-date">' + date + '</span>' +
        '</a>' +
      '</li>';
    }).join('');
  }
  
  function fetchRecentComments() {
    // Use JSONP to bypass CORS
    const script = document.createElement('script');
    script.src = 'https://disqus.com/api/3.0/forums/listPosts.jsonp' +
      '?forum=' + DISQUS_SHORTNAME +
      '&limit=50' +
      '&related=thread' +
      '&order=desc' +
      '&api_key=' + API_KEY +
      '&callback=disqusRecentCommentsCallback';
    
    script.onerror = function() {
      showError();
    };
    
    document.body.appendChild(script);
  }
  
  // Fetch comments when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchRecentComments);
  } else {
    fetchRecentComments();
  }
})();
</script>